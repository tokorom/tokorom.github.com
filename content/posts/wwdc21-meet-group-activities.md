---
title: "Wwdc21 Meet Group Activities"
date: 2021-06-10T12:56:44+09:00
draft: false
author: "tokorom"
authors: [tokorom]
tags: [WWDC21,SharePlay,iOS]
images: [/images/wwdc21-meet-group-activities/top.png]
canonical: https://spinners.work
---

![image](/images/wwdc21-meet-group-activities/top.png)

## 導入

離れた場所にいる人たちと同じ部屋にいるような感覚でアクティビティを楽しめる新しい方法として `SharePlay` は開発されました。

SharePlayは、`Group Activities`フレームワークによって実現されています。

このセッションでは、サードパーティ製アプリにSharePlayを採用する方法が紹介されています。

## Communication

![image](/images/wwdc21-meet-group-activities/ss-1623297704.png)

Appleは、スムーズに自然なコミュニケーションができることが最重要であると考え、FaceTimeとMessagesにSharePlayを組み込んでいます。

ユーザーは、自分にとって最も身近な人たち、友人や家族とのコミュニケーションにかなりの時間を費やしています。
それらは、映画を見るためにリビングルームに招待する対象となるような人たちです。

SharePlayで促進したいのは、まさにそのような人たちとの体験の共有です。

### Session

![image](/images/wwdc21-meet-group-activities/ss-1623298419.png)

SharePlayには、Sessionという概念があります。
Sessionを開始すると、ユーザーはいつものMessagesやFaceTimeで、テキスト、オーディオ、ビデオを使ったコミュニケーションができるようになります。
ユーザーはSessionの中でこれらを柔軟に切り替えられます。
開始済みのSessionに新しい人を招待したり、Sessionの途中で離脱もできます。

SessionをOSが管理してくれるため、ユーザーはSession中でもあらゆるアプリを利用することができます。

各アプリの開発者は、Group Activitiesを使えば、これらの機能を全て利用できます。

## Platform

![image](/images/wwdc21-meet-group-activities/ss-1623305725.png)

Group ActivitiesはiOS、iPadOS、macOSの全てに同じ体験を提供できます。
それだけでなくWebサイト（WebKitブラウザ）でも利用できます。
Apple TVでも動作するので、大画面のテレビでも楽しめます。

Sessionにはどのデバイスからも参加できますし、複数のデバイスをシームレスに使うこともできます。
AirPodsをはじめとするBluetoothデバイスにも素晴らしいオーディオを提供できるように設計されています。

### Playback

共視聴体験のトリガーになるのは、再生ボタンです。
ユーザーがどのコンテンツに時間を費やすかを決める瞬間です。

Appleは、すべての再生ボタンがSharePlayと連動することを目標としています。
ユーザーが友達とFaceTimeで話しているときに、アプリ内のメディアをいつでもSharePlayできるようにしたいと考えています。

各アプリが簡単にSharePlayできるよう、既存のコードそのままで使えように設計したAPIを提供しています。
グループで会話をしているときにいつでも、各アプリの再生ボタンからSharePlayを開始できるようになります。

## Time-Synced Playback

次に、時間に同期した再生です。

私たちは、人々が一緒に笑い、一緒に微笑み、コンテンツに同時に反応することが非常に重要だと考えています。

SharePlayは、再生時間の同期をプラットフォームレベルで管理しているので、自社での展開を気にすることなく、簡単に導入することができます。

さて、「SharePlay」でコンテンツを消費する際には、これは難しい問題でした。

私たちは、たとえ地球の反対側にいたとしても、お互いに全く同じ瞬間を体験できるようにしたいと考えました。

まだ起きてもいないことで友人が笑っているのを見聞きすることを想像してみてください。

ネタバレになりますが そこで私たちは、デバイス上のAVFoundationスタックに深く統合された、まったく新しい再生同期プロトコルを構築しました。

つまり、誰かが再生ボタンを押すと、グループの全員が同時に再生を開始するのです。

誰かが再生ボタンを押すと、グループ全員が同時に再生を開始します。お気に入りのシーンにジャンプすると、他の全員にもそのシーンが表示されるので、まるで同じ部屋にいるかのように、完璧な同期で一緒に体験することができます。

この再生同期の魔法は、あなたのメディアを再送信することは一切ありません。

すべての人が、あなたのアプリから再生され、いつものようにあなたのサーバーからストリーミングされているので、完全な忠実度の映像を得ることができます。

すべての視聴者が最高品質のビデオを見ることができるので、コンテンツの品質に妥協することなく、没入感のあるソーシャルビューイング体験を得ることができます。

また、再生中のコミュニケーションを自然なものにするために、画期的な取り組みを行っています。

スマートボリュームにより、再生中に人々が発言すると、コンテンツの音声が自動的にダッキングされ、必要に応じて再生されるようになります。

そのため、同じ部屋にいるかのように、音声や映像、テキストで自然にコミュニケーションをとることができます。

もちろん、Picture in Pictureとの相性も抜群で、ユーザーはデバイス上でマルチタスクをこなしながら、コンテンツを持ち歩くことができます。

以上、簡単にプラットフォームの概要を説明しました。

そして、最後にコンテンツです。ここであなたの出番となります。

私たちは、ユーザーがアプリで提供されている最高のコンテンツを楽しむことができるようにしたいと考えています。

FaceTimeで通話しているときに、アプリに入ってコンテンツを共有できることを期待しています。

SharePlayは、製品のタッチポイントを拡大し、ユーザーにとってアプリが関連する時間を増やすことを可能にしてくれます。

そして、これは非常に有機的に起こります。

既存のユーザーは、SharePlayを他の人と一緒に使っているうちに、あなたのアプリを広めてくれるでしょう。

さて、「SharePlay」の主要コンポーネントの概要を説明しましたが、次にフレームワークのコアコンセプトである「グループアクティビティ」に注目してみましょう。

グループ活動とは、SharePlayを使ってFaceTime通話をしている人たちと共有したり楽しんだりできるものを表すオブジェクトです。

それでは、ユーザーがアプリ内でグループアクティビティを開始する方法をご紹介しましょう。

通話中、ユーザーはあなたのアプリにナビゲートすることができ、グループアクティビティを採用している場合は、アプリがSharePlayをサポートしていることが通知されます。

共有したいアクティビティを構成するには、まずGroupActivityプロトコルを実装したオブジェクトを作成する必要があります。

アクティビティの設定が完了したら、prepareForActivation APIを呼び出して、そのアクティビティの共有を開始します。

このAPIでは、そのアクティビティをFaceTime通話に参加している全員と共有するか、ローカルにとどめておくかというオプションをユーザーに提示します。

ユーザーがグループで共有することを決めた場合、グループアクティビティから通知があり、GroupSessionオブジェクトに参加することができます。

ユーザーがグループセッションに参加すると、再生、一時停止、シークなどの操作をしても、ビデオはグループと同期したままになります。

それらのイベントが発生するたびに、Group Activitiesがここに示すように自動的にユーザーに通知します。

そして最後に、ユーザーは自分のため、またはグループ全体のためにアクティビティを終了することができます。

とてもシンプルですね。それでは、Bhaskarにこのプレゼンテーションの残りの部分を案内してもらいましょう。

Baskar Sarma: ありがとうございます、ピエール。

FaceTimeチームのエンジニア、バスカルです。

それでは、この新しいフレームワークの背景にある、ハイレベルなコンセプトとアーキテクチャについて説明しましょう。

GroupActivitiesは、Swiftネイティブのフレームワークで、FaceTime通話中のアプリケーションのユーザー間で共有体験を作ることができます。

また、このフレームワークは、AVFoundationと緊密に統合されており、ビデオやオーディオの再生体験を共有することができます。

APIのハイレベルなコンセプトを説明する前に、APIの2つの重要な部分、GroupActivityとGroupSessionについて説明したいと思います。

GroupActivityは、アプリケーションが共有体験を定義するために使用するものです。

アプリケーションが共有体験に必要とする情報を保持します。

例えば、オーディオやビデオの再生を共有する場合は、再生されるコンテンツのURLを保持します。

また、アプリケーションが独自の共有体験を提供する場合もあります。

例えば、引き寄せの体験を提供することができます。

その場合は、ユーザーが何を描いているかの情報を保持します。

GroupSessionは、基本的には、共有体験に参加するグループの表現です。

グループの参加者などへのアクセスを提供します。

また、フレームワークには、デバイス間でデータを送受信するためにGroupSessionと一緒に使用できる追加のAPIがあります。

なお、GroupSessionは大量のデータをやり取りするためのものではありません。

例えば、視聴体験を共有する場合、GroupSessionは曲の内容を交換するためには使用されません。

その代わり、このチャンネルはAVFoundationによって、再生、一時停止、シークのコマンドを交換することで、コンテンツを同期させるために使用されます。

また、GroupSessionが提供する通信媒体は、エンドツーエンドで暗号化されています。

つまり、端末上の自分のアプリケーション以外は、このチャンネルでやり取りされるデータを読むことができないのです。

ここでは、画面上に2台の携帯電話が表示されています。

左側が私の携帯電話で、右側がチームメイトのPierreの携帯電話です。

FaceTimeで通話しています。

また、画面には「Awesome App」というサンプルアプリケーションが表示されていて、私とピエールの間で共有体験を開始する準備ができています。

この場合、左のデバイスにあるアプリケーションがアクティビティを開始することになります。

アプリケーションが最初にすべきことは、GroupActivityプロトコルに準拠したオブジェクトを作成することです。

この例では、GroupActivityに準拠したAwesomeActivityオブジェクトを作成しています。

先に述べたように、このGroupActivityプロトコルに準拠したオブジェクトには、共有アクティビティに関する情報が含まれています。

例えば、共有の再生体験を作っている場合、どのようなコンテンツを再生するかという情報を持つことになります。

また、一緒に何かを描くようなカスタムエクスペリエンスを作成する場合は、何を描くかについての情報が含まれます。

アプリがアクティビティを作成したら、次にすべきことは、そのアクティビティのprepareForActivationを呼び出すことです。

これにより、ユーザーにはアクティビティを開始するかどうかの許可を求めるプロンプトが表示されます。

ユーザーを驚かせたくないので、アクティビティを開始する前にユーザーの同意を得たいと考えています。

そのため、このステップは必須です。

最後に、ユーザーがアクティビティの開始を許可した後、アプリはアクティビティ・オブジェクトのactivateを呼び出す必要があります。

これにより、アプリが共有体験の開始を望んでいることがシステムに伝えられます。

次に、Sessionの観察について説明します。

ここでは、先ほどと同じアプリを見てみましょう。

この時点で、アプリケーションはアクティビティ・オブジェクトのactivateを呼び出しています。

次にアプリケーションはGroupSessionクラスのAsyncSequenceを介して、入ってくるSessionを繰り返し処理する必要があります。

そして、Sessionがあると、アプリケーションは共有体験のためのGroupSessionオブジェクトを手にします。

これは、アプリケーションがSessionを開始する側であっても、Sessionを受けるリモートデバイス側であっても、同じ手順で行われることに注意してください。

グループセッションの開始と観察についての詳細は、WWDCのSessionをご覧になることをお勧めします。

Sessionを渡されたアプリケーションは、Sessionに参加する前に自分自身をセットアップする必要があります。

Sessionに参加する前にアプリケーションをセットアップすることは、アプリケーションの特定のユースケースに応じて異なる意味を持ちます。

例えば、何かを一緒に描くようなカスタム体験を作っている場合は、ユーザーが体験に参加する前に、共有体験に必要なアセットをロードすることになります。

しかし、アプリケーションがメディア再生の共有体験を提供している場合は、次のようになります。

アプリケーションは、AVPlayerのAVPlaybackCoordinatorをGroupSessionにフックして、関連するAVPlayerがフレームワークが提供する通信チャネルを介してコンテンツを同期できるようにします。

この同期サポートは、AVPlayerに限らず、あなたが現在持っている他のカスタムビデオプレーヤーを使用しても、AVDelegating PlaybackCoordinatorを介して同期のサポートを得ることができることを覚えておいてください。

そして最後に、アプリケーションの設定が完了したら、アプリケーションはGroupSessionのjoinを呼び出します。

joinが呼ばれると、システムは異なるデバイスで動作するアプリケーション間のエンドツーエンドの暗号化されたチャンネルを設定します。

この時点で、アプリケーションはデータを同期し、ユーザーが共有体験に参加できるようになります。

カスタムエクスペリエンスを作成している場合、アプリケーションはこのチャネルを使用してデータを交換し、ユーザーを同期させることができます。

このチャンネルは、AVFoundationでも使用されており、ユーザーが再生、一時停止、スキップなどを行った際に再生状態を交換することで、メディアの再生を同期させています。

なお、このチャンネルは、大量のデータをやり取りするためのものではありません。

このチャンネルは、大量のデータをやり取りするためのものではなく、ユーザーの同期をとるための情報をやり取りするために使用します。

これで、あなたのアプリケーションはSessionに入り、ユーザーはその体験を共有して楽しんでいます。

ユーザーの体験を豊かにするために、もう一つできることがあります。それは、フレームワークを使ってイベントを投稿することです。

イベントを投稿することで、ユーザーは共有体験で何が起こっているのかを知ることができます。

例えば、誰かがトラックを再生したり、一時停止したり、スキップしたりしたことをユーザーに知らせるために、イベントを投稿することができます。

イベントを投稿すると、システムはそのイベントについての通知をユーザーに提示します。

現在のAPIでは、メディア再生体験のためのイベントを投稿することしかできません。

AVPlayerやAVDelegating PlaybackCoordinatorを使用している場合は、無料でイベントを投稿できます。

しかし、これらを使用していなくても、フレームワークを使用してイベントを投稿することができます。

独自のカスタム体験の提供やイベントの投稿について詳しく知りたい方は、このWWDCのSessionをご覧になることをお勧めします。

最後に、Group Activitiesは、FaceTimeでの共有体験を可能にする、Swiftネイティブの全く新しいフレームワークです。

このフレームワークはクロスプラットフォームで、iOS、macOS、iPadOS、tvOSで利用できます。

このフレームワークは、AVFoundationと緊密に統合されており、アプリでメディア再生の共有体験を提供することができます。

また、macOSではウェブ上での再生同期にも対応しています。


それでは、私たちのSessionをご覧いただき、ありがとうございました。
